<div class="card">
  <lib-ticket-overview-skeleton *ngIf="loading$ | async"></lib-ticket-overview-skeleton>

  <lib-page-error *ngIf="error$ | async as error" [error]="error">
    <p>Не удалось загрузить заявку. Попробуйте обновить страницу.</p>
  </lib-page-error>

  <div *ngIf="sdRequest$ | async as sdRequest">
    <div class="p-grid">
      <div class="p-col-3">
        <div
          *ngFor="
            let history of (orderedHistories$ | async).slice().reverse();
            trackBy: trackByHistory;
            let index = index
          "
        >
          <lib-history-event-card [history]="history" [num]="index + 1"></lib-history-event-card>
        </div>
      </div>
      <div class="p-col-6">
        <div class="p-m-3">
          <div class="ticket-overview-header">
            #{{ sdRequest.id }}
            <span class="p-ml-3">{{ sdRequest.service_name }}. {{ sdRequest.ticket_name }}</span>
          </div>
          <div class="p-mt-2">
            <span class="text-secondary">пользователь</span>
            <span class="text-primary p-ml-2">{{ sdRequest.source_snapshot.fio }}</span>
            <span class="text-secondary p-ml-2">от</span>
            <span class="p-mr-2 p-ml-2">{{ sdRequest.runtime.created_at | datetime }}</span> |
            <span class="p-ml-2">
              <b>
                выполнить до:
                <span class="p-ml-1">{{ sdRequest.runtime.finished_at_plan | datetime }}</span>
              </b>
            </span>
          </div>
        </div>

        <div class="p-mt-3">
          <p-tabView>
            <p-tabPanel header="Детали">
              <p-panel header="Описание">
                <div *ngIf="sdRequest.description; else noDesc">{{ sdRequest.description }}</div>
                <ng-template #noDesc>
                  <lib-panel-placeholder>[ Пусто ]</lib-panel-placeholder>
                </ng-template>
              </p-panel>
            </p-tabPanel>
            <p-tabPanel header="Параметры">
              <p>
                Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam
                rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt
                explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia
                consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Consectetur, adipisci velit, sed
                quia non numquam eius modi.
              </p>
            </p-tabPanel>
            <p-tabPanel header="Исполнители">
              <p>
                At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum
                deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non
                provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.
                Et harum quidem rerum facilis est et expedita distinctio. Nam libero tempore, cum soluta nobis est
                eligendi optio cumque nihil impedit quo minus.
              </p>
            </p-tabPanel>
            <p-tabPanel header="Комментарии">
              <p>
                At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum
                deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non
                provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.
                Et harum quidem rerum facilis est et expedita distinctio. Nam libero tempore, cum soluta nobis est
                eligendi optio cumque nihil impedit quo minus.
              </p>
            </p-tabPanel>
          </p-tabView>
        </div>
      </div>
      <div class="p-col-3">
        <lib-detail-row class="p-mb-2">
          <div attribute>Статус</div>
          <div value>
            <span [class]="'sd-request-badge status-' + status(sdRequest.status).badge">{{
              status(sdRequest.status).title
            }}</span>
          </div>
        </lib-detail-row>

        <lib-detail-row class="p-mb-2">
          <div attribute>Приоритет</div>
          <div value>
            <span [class]="'sd-request-badge priority-' + priority(sdRequest.priority).badge">{{
              priority(sdRequest.priority).title
            }}</span>
          </div>
        </lib-detail-row>

        <lib-detail-row class="p-mb-2">
          <div attribute>Имя приложения</div>
          <div value>{{ sdRequest.application?.name }}</div>
        </lib-detail-row>

        <lib-detail-row class="p-mb-2">
          <div attribute>Внешний ID</div>
          <div value>{{ sdRequest.integration_id }}</div>
        </lib-detail-row>

        <p-divider></p-divider>

        <h3>Актуальные данные:</h3>
        <p-accordion [multiple]="true">
          <p-accordionTab [selected]="(loadingEmployee$ | async) === false && (employee$ | async)">
            <ng-template pTemplate="header">
              <div class="panel-header">
                <span>Пользователь</span>
                <span *ngIf="loadingEmployee$ | async">
                  <i class="mdi mdi-loading mdi-spin mdi-18px"></i>
                </span>
              </div>
            </ng-template>
            <ng-template pTemplate="content">
              <ng-container *ngIf="loadingEmployee$ | async; then loadingData"></ng-container>
              <div *ngIf="loadedEmployee$ | async">
                <div *ngIf="employee$ | async as employee; else unknownData">
                  <lib-detail-row class="p-mb-2">
                    <div attribute>ФИО</div>
                    <div value>{{ employee.lastName }} {{ employee.firstName }} {{ employee.middleName }}</div>
                  </lib-detail-row>

                  <div *ngIf="employee.employeePositions as positions">
                    <lib-detail-row class="p-mb-2">
                      <div attribute>Должность</div>
                      <div value>{{ positions[0].professionForAccounting }}</div>
                    </lib-detail-row>

                    <lib-detail-row class="p-mb-2">
                      <div attribute>Категория</div>
                      <div value>{{ positions[0].employeeCategory }}</div>
                    </lib-detail-row>

                    <lib-detail-row class="p-mb-2">
                      <div attribute>Подразделение</div>
                      <div value>{{ positions[0].departmentForAccounting }} | {{ positions[0].struct }}</div>
                    </lib-detail-row>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-accordionTab>
          <p-accordionTab header="Хост">
            <lib-panel-placeholder>[Пусто]</lib-panel-placeholder>
          </p-accordionTab>
          <p-accordionTab [selected]="(loadingSvtItem$ | async) === false && (svtItem$ | async)">
            <ng-template pTemplate="header">
              <div class="panel-header">
                <span>Техника</span>
                <span *ngIf="loadingSvtItem$ | async">
                  <i class="mdi mdi-loading mdi-spin mdi-18px"></i>
                </span>
              </div>
            </ng-template>
            <ng-template pTemplate="content">
              <div *ngIf="loadedSvtItem$ | async">
                <div *ngIf="svtItem$ | async as svtItem; else unknownData">
                  <lib-detail-row class="p-mb-2">
                    <div attribute>Тип</div>
                    <div value>{{ svtItem.type.short_description }}</div>
                  </lib-detail-row>

                  <lib-detail-row class="p-mb-2">
                    <div attribute>Модель</div>
                    <div value>{{ svtItem.short_item_model }}</div>
                  </lib-detail-row>

                  <lib-detail-row class="p-mb-2">
                    <div attribute>Инв. №</div>
                    <div value>{{ svtItem.invent_num }}</div>
                  </lib-detail-row>

                  <lib-detail-row class="p-mb-2">
                    <div attribute>Штрих-код</div>
                    <div value>{{ svtItem.barcode_item?.id }}</div>
                  </lib-detail-row>

                  <lib-detail-row class="p-mb-2">
                    <div attribute>ID РМ</div>
                    <div value>{{ svtItem.workplace_id }}</div>
                  </lib-detail-row>
                </div>
              </div>
            </ng-template>
            <ng-container *ngIf="loadingSvtItem$ | async; then loadingData"></ng-container>
          </p-accordionTab>
        </p-accordion>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingData>
  <lib-panel-placeholder>[Загрузка...]</lib-panel-placeholder>
</ng-template>

<ng-template #unknownData>
  <lib-panel-placeholder>[Не удалось обработать данные]</lib-panel-placeholder>
</ng-template>

<ng-template #emptyData>
  <lib-panel-placeholder>[Пусто]</lib-panel-placeholder>
</ng-template>
