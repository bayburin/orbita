<form [formGroup]="form">
  <div class="field">
    <label for="category_id">Категория</label>
    <p-dropdown
      id="category_id"
      formControlName="category_id"
      [options]="categories$ | async"
      [showClear]="true"
      placeholder="Выберите категорию"
      optionValue="id"
      optionLabel="name"
      appendTo="body"
      styleClass="w-full inputfield"
      [ngClass]="{ 'ng-invalid ng-dirty': (categoryIdForm.touched || submitted) && categoryIdForm.errors }"
    >
    </p-dropdown>
    <small class="p-error" *ngIf="(categoryIdForm.touched || submitted) && categoryIdForm.errors"
      >Не может быть пустым</small
    >
  </div>
  <div class="field">
    <label for="name">Наименование услуги</label>
    <input
      id="name"
      type="text"
      pInputText
      formControlName="name"
      class="inputfield w-full"
      autofocus
      [ngClass]="{ 'ng-invalid ng-dirty': (nameForm.touched || submitted) && nameForm.errors }"
    />
    <small class="p-error" *ngIf="(nameForm.touched || submitted) && nameForm.errors">Не может быть пустым</small>
  </div>
  <div class="field">
    <label for="short_description">Описание</label>
    <textarea
      id="short_description"
      pInputTextarea
      formControlName="short_description"
      class="inputfield w-full"
    ></textarea>
  </div>
  <div class="field-checkbox">
    <p-checkbox inputId="is_hidden" formControlName="is_hidden" [binary]="true"></p-checkbox>
    <label class="mb-0" for="is_hidden">Скрыть от пользователя</label>
  </div>
  <div class="field-checkbox">
    <p-checkbox inputId="has_common_case" formControlName="has_common_case" [binary]="true"></p-checkbox>
    <label class="mb-0" for="has_common_case">Возможность создать заявку в свободной форме на данную услугу</label>
  </div>
  <div formArrayName="responsible_users">
    <div class="mb-2">
      <label>Ответственные за услугу</label>
      <button
        pButton
        type="button"
        class="p-button-rounded p-button-text p-button-icon-only p-button-plain ml-2"
        (click)="addUser()"
      >
        <i class="mdi mdi-plus-circle-outline mdi-18px"></i>
      </button>
    </div>

    <div *ngFor="let control of responsibleUsersForm.controls; let i = index">
      <div [ngClass]="{ hidden: getResponsibleUserDestroyForm(i).value }" [formGroupName]="i" class="formgrid grid">
        <div class="field col">
          <p-autoComplete
            #employeeAutoComplete
            formControlName="details"
            [suggestions]="employees$ | async"
            [showEmptyMessage]="true"
            [minLength]="3"
            [virtualScroll]="true"
            scrollHeight="300px"
            [itemSize]="50"
            field="fullName"
            placeholder="Введите ФИО или табельный номер"
            appendTo="body"
            styleClass="w-full"
            inputStyleClass="w-full"
            (completeMethod)="searchEmployee($event)"
            (onSelect)="selectEmployee($event, i)"
            (onFocus)="showEmployeeAutoComplete(i)"
            (onClear)="clearEmployee(i)"
          >
            <ng-template let-employee pTemplate="item">
              <p-chip [label]="employee.departmentForAccounting"></p-chip>
              <span class="ml-3">{{ employee.fullName }}</span>
            </ng-template>
          </p-autoComplete>
          <small
            class="p-error"
            *ngIf="(getResponsibleUserTnForm(i).touched || submitted) && getResponsibleUserTnForm(i).errors"
            >Не может быть пустым</small
          >
        </div>
        <div
          *ngIf="getResponsibleUserTnForm(i).value"
          class="field col-2 flex align-items-center justify-content-center"
        >
          <span>Таб. № {{ getResponsibleUserTnForm(i).value }}</span>
        </div>
        <div class="field flex align-items-center">
          <button
            pButton
            type="button"
            class="p-button-rounded p-button-text p-button-icon-only p-button-plain"
            (click)="removeUser(i)"
          >
            <i class="mdi mdi-minus-circle-outline mdi-18px"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</form>

<p-divider></p-divider>

<div class="text-right mt-3">
  <button type="submit" [disabled]="formLoading$ | async" (click)="submitForm()" class="btn btn-primary">
    <span class="d-flex justify-content-center">
      <lib-loading [loading]="formLoading$ | async" class="mr-1 text-body"></lib-loading>Сохранить
    </span>
  </button>
  <button (click)="closeForm()" class="btn btn-gray-white ml-3">Отменить</button>
</div>
